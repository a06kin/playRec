<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Players</title>
<link type="text/css" rel="stylesheet" href="css/materialize.min.css"/>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col m12" id="files">
        <div class="card-panel">
          <div><h5 class="center-align">Drag&Drop fil—ã here</h5></div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col m12 center">
        <a class="waves-effect waves-light btn" onclick="playAll();">playAll</a>
        <a class="waves-effect waves-light btn" onclick="pauseAll();">pauseAll</a>
        <a class="waves-effect waves-light btn" onclick="stopAll();">stopAll</a>
        <a class="waves-effect waves-light btn" onclick="startRecording();">record</a>
        <a class="waves-effect waves-light btn" onclick="stopRecording();">stop record</a>
        <a class="waves-effect waves-light btn" onclick="startRecordAndPlay();">Record&Play</a>
      </div>
    </div>

    <div class="row">
      <div class="col m12 center">
        <div class="progress" id="rec">
          <div class="indeterminate"></div>
        </div>
      </div>
    </div>

    <audio class="players" id="defPlayer" controls hidden>
      <source type="audio/mp3">
      Your browser does not support the audio element.
    </audio>

    <ul id="playerList" class="collection">
    </ul>

    <h2>Log</h2>
    <pre id="log"></pre>
  </div>


</body>

<script type="text/javascript">

  var audiofiles = [];
  var audio_context;
  var recorder;
  var isRec = false;

  function hide(obj){
    obj.style.display = 'none';
  }

  function show(obj){
    obj.style.display = 'block';
  }

  function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }

  function playAll() {
    var els = document.getElementsByClassName('players');
    var arrayLength = els.length;
    for (var i = 1; i < arrayLength; i++) {
      els[i].play();
    }
  }

  function pauseAll() {
    var els = document.getElementsByClassName('players');
    var arrayLength = els.length;
    for (var i = 1; i < arrayLength; i++) {
      els[i].pause();
    }
  }

  function stopAll() {
    var els = document.getElementsByClassName('players');
    var arrayLength = els.length;
    for (var i = 1; i < arrayLength; i++) {
      els[i].pause();
      els[i].currentTime = 0;
    }
  }

  function createNewPlayer(file) {
    var freader = new FileReader();

    freader.onload = function(e) {
      var pl = document.getElementById("defPlayer");
      var cln = pl.cloneNode(true);
      var output = [];
      cln.src = e.target.result;

      var li = document.createElement("li");
      li.appendChild(cln);
      document.getElementById("playerList").appendChild(li);
      cln.removeAttribute("hidden");
      cln.removeAttribute("id");
      output.push('<strong>', file.name, '<'+'/strong>');
      li.innerHTML += output.join('');
    };

    freader.readAsDataURL(file);
  }

  function handleDragOver(e) {
    e.stopPropagation();
    e.preventDefault();
  }

  function handleDrop(e) {
    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files,
      output = [], i, f;

    for(i=0; f = files[i]; i++) {

      // output.push('<li><strong>', f.name, '<'+'/strong> - ', f.size, ' bytes<'+'/li>');
      if(f.type === 'audio/mp3'){
        audiofiles.push(f);
        createNewPlayer(f);
      }
    }
  }

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('Media stream created.');
    // Uncomment if you want the audio to feedback directly
    //input.connect(audio_context.destination);
    //__log('Input connected to audio context destination.');

    recorder = new Recorder(input);
    __log('Recorder initialised.');
  }

  function startRecording() {
    if (!isRec){
      show(rec);
      isRec = true;
      recorder && recorder.record();
      __log('Recording...');
    }
  }

  function stopRecording() {
    if (isRec){
      hide(rec);
      isRec = false;
      recorder && recorder.stop();
      __log('Stopped recording.');

      // create WAV download link using audio data blob
      createDownloadLink();

      recorder.clear();


    }
  }

  function startRecordAndPlay() {
    if (!isRec){
      show(rec);
      playAll();
      startRecording();
      __log('Play & Record');
    }
  }

  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('a');

      au.controls = true;
      au.setAttribute("class", "players");
      au.src = url;
      hf.href = url;
      hf.download = new Date().toISOString() + '.wav';
      hf.innerHTML = hf.download;
      li.appendChild(au);
      li.appendChild(hf);
      playerList.appendChild(li);
    });
  }

  (
    function () {
      hide(rec);

      var file_drop = document.getElementById('files');

      file_drop.addEventListener('dragover', handleDragOver, false);
      file_drop.addEventListener('drop', handleDrop, false);

      try {
        // webkit shim
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;

        audio_context = new AudioContext;
        __log('Audio context set up.');
        __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
      } catch (e) {
        __log(e);
        alert('No web audio support in this browser!');
      }

      navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
        __log('No live audio input: ' + e);
      });
    }
  )();
</script>

<script type="text/javascript" src="js/recorder.js"></script>

</html>
